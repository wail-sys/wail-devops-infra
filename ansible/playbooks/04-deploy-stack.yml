---
- name: Déploiement stack Docker
  hosts: vps
  become: yes

  tasks:
    - name: Copie fichiers monitoring
      synchronize:
        src: ../../monitoring/
        dest: /opt/docker/
        delete: no
        rsync_opts:
          - "--exclude=*.md"

    - name: Template fichier .env
      template:
        src: templates/env.j2
        dest: /opt/docker/.env
        mode: '0600'

    - name: Démarrage stack Docker
      command: docker compose up -d
      args:
        chdir: /opt/docker

    - name: Attente démarrage services
      wait_for:
        port: "{{ item }}"
        delay: 5
        timeout: 60
      loop:
        - 80
        - 443
        - 9090
        - 3000
