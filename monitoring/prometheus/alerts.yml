# Règles d'alerting Prometheus

groups:
  # ================================
  # ALERTES SYSTÈME
  # ================================
  - name: system_alerts
    interval: 30s
    rules:
      # Alerte : CPU élevé
      - alert: HighCPUUsage
        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "CPU usage is above 80% on {{ $labels.instance }}"
          description: "CPU usage is {{ $value }}% for more than 5 minutes"

      # Alerte : CPU critique
      - alert: CriticalCPUUsage
        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
        for: 2m
        labels:
          severity: critical
          category: system
        annotations:
          summary: "CRITICAL: CPU usage is above 95% on {{ $labels.instance }}"
          description: "CPU usage is {{ $value }}% for more than 2 minutes"

      # Alerte : RAM élevée
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 80
        for: 5m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "Memory usage is above 80% on {{ $labels.instance }}"
          description: "Memory usage is {{ $value }}% for more than 5 minutes"

      # Alerte : RAM critique
      - alert: CriticalMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 95
        for: 2m
        labels:
          severity: critical
          category: system
        annotations:
          summary: "CRITICAL: Memory usage is above 95% on {{ $labels.instance }}"
          description: "Only {{ $value }}% RAM available"

      # Alerte : Disque plein
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 10
        for: 5m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "Disk space is below 10% on {{ $labels.instance }}"
          description: "Only {{ $value }}% disk space remaining"

      # Alerte : Disque critique
      - alert: DiskSpaceCritical
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 5
        for: 2m
        labels:
          severity: critical
          category: system
        annotations:
          summary: "CRITICAL: Disk space is below 5% on {{ $labels.instance }}"
          description: "Only {{ $value }}% disk space remaining - URGENT ACTION REQUIRED"

  # ================================
  # ALERTES DOCKER
  # ================================
  - name: docker_alerts
    interval: 30s
    rules:
      # Alerte : Conteneur arrêté
      - alert: ContainerDown
        expr: up{job="cadvisor"} == 0
        for: 1m
        labels:
          severity: critical
          category: docker
        annotations:
          summary: "Container {{ $labels.name }} is down"
          description: "Container has been down for more than 1 minute"

      # Alerte : Container utilise trop de RAM
      - alert: ContainerHighMemory
        expr: (sum by (name) (container_memory_usage_bytes{name!=""}) / sum by (name) (container_spec_memory_limit_bytes{name!=""})) * 100 > 90
        for: 5m
        labels:
          severity: warning
          category: docker
        annotations:
          summary: "Container {{ $labels.name }} is using more than 90% of its memory limit"
          description: "Memory usage is {{ $value }}%"

  # ================================
  # ALERTES RÉSEAU
  # ================================
  - name: network_alerts
    interval: 30s
    rules:
      # Alerte : Bande passante élevée
      - alert: HighNetworkTraffic
        expr: rate(node_network_receive_bytes_total[5m]) > 100000000  # 100MB/s
        for: 5m
        labels:
          severity: warning
          category: network
        annotations:
          summary: "High network traffic on {{ $labels.instance }}"
          description: "Network receiving {{ $value }} bytes/s"

  # ================================
  # ALERTES SERVICES
  # ================================
  - name: service_alerts
    interval: 30s
    rules:
      # Alerte : Service Prometheus down
      - alert: PrometheusDown
        expr: up{job="prometheus"} == 0
        for: 1m
        labels:
          severity: critical
          category: service
        annotations:
          summary: "Prometheus is down"
          description: "Prometheus monitoring is not available"

      # Alerte : Node Exporter down
      - alert: NodeExporterDown
        expr: up{job="node_exporter"} == 0
        for: 2m
        labels:
          severity: critical
          category: service
        annotations:
          summary: "Node Exporter is down"
          description: "System metrics are not being collected"

      # Alerte : cAdvisor down
      - alert: CAdvisorDown
        expr: up{job="cadvisor"} == 0
        for: 2m
        labels:
          severity: warning
          category: service
        annotations:
          summary: "cAdvisor is down"
          description: "Docker metrics are not being collected"

  # ================================
  # ALERTES DISPONIBILITÉ (optionnel)
  # ================================
  # Nécessite Blackbox Exporter
  # - name: availability_alerts
  #   interval: 30s
  #   rules:
  #     - alert: WebsiteDown
  #       expr: probe_success{job="blackbox"} == 0
  #       for: 2m
  #       labels:
  #         severity: critical
  #         category: availability
  #       annotations:
  #         summary: "Website {{ $labels.instance }} is down"
  #         description: "HTTP probe failed for more than 2 minutes"
  #
  #     - alert: SlowResponseTime
  #       expr: probe_duration_seconds{job="blackbox"} > 3
  #       for: 5m
  #       labels:
  #         severity: warning
  #         category: performance
  #       annotations:
  #         summary: "Slow response time on {{ $labels.instance }}"
  #         description: "Response time is {{ $value }}s (> 3s threshold)"
